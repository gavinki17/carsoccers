<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3D Web Rocket League</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; text-shadow: 2px 2px 4px #000; pointer-events: none; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>Web Rocket League</h2>
        <p>WASD: Drive | Space: Jump/Flip | Shift: Boost</p>
        <div id="score">BLUE 0 - 0 RED</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import * as CANNON from 'cannon-es';

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);
        const world = new CANNON.World({ gravity: new CANNON.Vec3(0, -20, 0) });
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- ARENA & GOALS ---
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x1d4d1d });
        const groundGeo = new THREE.PlaneGeometry(80, 120);
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        const groundBody = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
        groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
        world.addBody(groundBody);

        // Simple Goal Creation
        function createGoal(zPos, color) {
            const group = new THREE.Group();
            const mat = new THREE.MeshBasicMaterial({ color: color, wireframe: true });
            const frame = new THREE.Mesh(new THREE.BoxGeometry(20, 10, 5), mat);
            frame.position.set(0, 5, zPos);
            scene.add(frame);
        }
        createGoal(-60, 0x00aaff); // Blue Goal
        createGoal(60, 0xff4400);  // Red Goal

        // --- THE CAR (CHASSIS + WHEELS) ---
        const carBody = new CANNON.Body({ mass: 150 });
        carBody.addShape(new CANNON.Box(new CANNON.Vec3(1.2, 0.5, 2)));
        carBody.position.set(0, 2, 40);
        world.addBody(carBody);

        const carMesh = new THREE.Mesh(new THREE.BoxGeometry(2.4, 1, 4), new THREE.MeshStandardMaterial({ color: 0x3498db }));
        scene.add(carMesh);

        // Raycast Vehicle Configuration
        const vehicle = new CANNON.RaycastVehicle({ chassisBody: carBody });
        
        const wheelOptions = {
            radius: 0.5,
            directionLocal: new CANNON.Vec3(0, -1, 0),
            suspensionStiffness: 30,
            suspensionRestLength: 0.3,
            frictionSlip: 1.4,
            rollInfluence: 0.1,
            axleLocal: new CANNON.Vec3(1, 0, 0),
            chassisConnectionPointLocal: new CANNON.Vec3(1, 0, 1)
        };

        // Add 4 Wheels
        const wheelMeshes = [];
        const positions = [[1, 0, 1.5], [-1, 0, 1.5], [1, 0, -1.5], [-1, 0, -1.5]];
        positions.forEach(pos => {
            wheelOptions.chassisConnectionPointLocal.set(...pos);
            vehicle.addWheel(wheelOptions);
            const wMesh = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.4, 16), new THREE.MeshStandardMaterial({ color: 0x222222 }));
            wMesh.rotation.z = Math.PI / 2;
            wheelMeshes.push(wMesh);
            scene.add(wMesh);
        });
        vehicle.addToWorld(world);

        // --- THE BALL ---
        const ballBody = new CANNON.Body({ mass: 10, shape: new CANNON.Sphere(1.5) });
        ballBody.position.set(0, 5, 0);
        ballBody.linearDamping = 0.1;
        world.addBody(ballBody);
        const ballMesh = new THREE.Mesh(new THREE.SphereGeometry(1.5, 32, 32), new THREE.MeshStandardMaterial({ color: 0xffffff }));
        scene.add(ballMesh);

        // --- LIGHTING ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const light = new THREE.PointLight(0xffffff, 100);
        light.position.set(0, 20, 0);
        scene.add(light);

        // --- CONTROLS ---
        const keys = {};
        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function animate() {
            requestAnimationFrame(animate);
            world.fixedStep();

            // Driving Logic
            const engineForce = 1500;
            const steeringValue = 0.5;

            vehicle.applyEngineForce(keys['w'] ? -engineForce : (keys['s'] ? engineForce : 0), 2);
            vehicle.applyEngineForce(keys['w'] ? -engineForce : (keys['s'] ? engineForce : 0), 3);
            
            let steer = 0;
            if (keys['a']) steer = steeringValue;
            if (keys['d']) steer = -steeringValue;
            vehicle.setSteeringValue(steer, 0);
            vehicle.setSteeringValue(steer, 1);

            // Jump / Flip
            if (keys[' '] && Math.abs(carBody.velocity.y) < 0.5) {
                carBody.applyImpulse(new CANNON.Vec3(0, 1000, 0));
            }

            // Sync Car Visuals
            carMesh.position.copy(carBody.position);
            carMesh.quaternion.copy(carBody.quaternion);
            
            // Sync Wheel Visuals
            for (let i = 0; i < vehicle.wheelInfos.length; i++) {
                vehicle.updateWheelTransform(i);
                const t = vehicle.wheelInfos[i].worldTransform;
                wheelMeshes[i].position.copy(t.position);
                wheelMeshes[i].quaternion.copy(t.quaternion);
            }

            ballMesh.position.copy(ballBody.position);

            // Camera follow
            camera.position.lerp(new THREE.Vector3(carBody.position.x, carBody.position.y + 6, carBody.position.z + 12), 0.1);
            camera.lookAt(carBody.position);

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
